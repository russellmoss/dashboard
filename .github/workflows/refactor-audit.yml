name: Weekly Refactoring Audit

on:
  schedule:
    - cron: '0 8 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  audit-refactoring:
    runs-on: ubuntu-latest
    env:
      BASELINE_LARGE_FILES: 25
      BASELINE_TODOS: 4
      # Updated 2026-02-18: actual production high-severity count after npm audit fix (axios resolved).
      # Remaining 7 are unfixable without major upgrades: 5x @sentry/nextjs cascade + 2x next.js.
      # See tech_debt_exploration.md Phase 3 for full advisory breakdown.
      BASELINE_VULNS: 7
      # Updated 2026-02-18: replaced grep-based detection (86 false positives) with knip AST analysis.
      # Updated 2026-02-19: dead code cleanup removed DEFAULT_YEAR + 7 unused files (92→91).
      # knip reports 91 genuinely unused value exports across src/. See knip.json for config.
      # See tech_debt_exploration.md PRE-IMPLEMENTATION VERIFICATION Q1 for breakdown.
      BASELINE_DEAD_EXPORTS: 91
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for large files (over 500 lines)
        id: large-files
        run: |
          find src/ \( -name "*.ts" -o -name "*.tsx" \) -print0 | \
            xargs -0 wc -l 2>/dev/null | \
            sort -rn | \
            awk '$1 > 500 && $2 != "total" {print $0}' > /tmp/large-files.txt
          LARGE_COUNT=$(wc -l < /tmp/large-files.txt | tr -d ' ')
          echo "large_count=$LARGE_COUNT" >> $GITHUB_OUTPUT

      - name: Scan for TODO/HACK/FIXME comments
        id: todos
        run: |
          grep -rn "TODO\|HACK\|FIXME\|XXX" src/ --include="*.ts" --include="*.tsx" \
            > /tmp/todos.txt 2>/dev/null || true
          TODO_COUNT=$(wc -l < /tmp/todos.txt | tr -d ' ')
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT

      - name: Run npm audit
        id: npm-audit
        run: |
          # --omit=dev replaces deprecated --production flag (forward-compatible with npm 11+)
          npm audit --omit=dev --json 2>/dev/null > /tmp/npm-audit.json || true
          HIGH_COUNT=$(node -e "
            try {
              const d = JSON.parse(require('fs').readFileSync('/tmp/npm-audit.json', 'utf8'));
              const v = d.metadata && d.metadata.vulnerabilities;
              console.log(v ? (v.high || 0) : 0);
            } catch(e) { console.log(0); }
          ")
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          npm audit --omit=dev 2>/dev/null | tail -5 > /tmp/npm-audit-summary.txt || true

      - name: Scan for unused exports (knip)
        id: dead-exports
        run: |
          # knip exits 1 when unused exports are found (expected linting behavior).
          # || true prevents non-zero exit from killing the step — mirrors npm audit pattern.
          npx knip --reporter json 2>/dev/null > /tmp/knip-output.json || true

          # Extract unused value export count from knip JSON output.
          # knip JSON schema: { issues: [{ file, exports: [{ name, ... }] }], files: [...] }
          # We count individual exports across all files, NOT unused files.
          DEAD_COUNT=$(node -e "
            try {
              const d = JSON.parse(require('fs').readFileSync('/tmp/knip-output.json', 'utf8'));
              const issues = d.issues || [];
              let count = 0;
              issues.forEach(i => { count += (i.exports || []).length; });
              console.log(count);
            } catch(e) { console.log(0); }
          ")
          echo "dead_count=$DEAD_COUNT" >> $GITHUB_OUTPUT

          # Build a human-readable list for the issue body
          node -e "
            try {
              const d = JSON.parse(require('fs').readFileSync('/tmp/knip-output.json', 'utf8'));
              const issues = d.issues || [];
              const lines = [];
              issues.forEach(i => {
                (i.exports || []).forEach(e => {
                  lines.push('- \`' + e.name + '\` in ' + i.file);
                });
              });
              const files = (d.files || []).map(f => typeof f === 'string' ? f : f.file || f);
              if (files.length) {
                lines.push('');
                lines.push('**Entirely unused files:**');
                files.forEach(f => lines.push('- ' + f));
              }
              require('fs').writeFileSync('/tmp/dead-exports.txt', lines.join('\n'));
            } catch(e) {
              require('fs').writeFileSync('/tmp/dead-exports.txt', 'knip analysis unavailable');
            }
          " 2>/dev/null || true

      - name: Determine if issue is needed
        id: should-create-issue
        run: |
          LARGE=$(( ${{ steps.large-files.outputs.large_count }} + 0 ))
          TODOS=$(( ${{ steps.todos.outputs.todo_count }} + 0 ))
          HIGH=$(( ${{ steps.npm-audit.outputs.high_count }} + 0 ))
          DEAD=$(( ${{ steps.dead-exports.outputs.dead_count }} + 0 ))

          NEEDS_ISSUE=false
          if [ "$LARGE" -gt "${{ env.BASELINE_LARGE_FILES }}" ] || \
             [ "$TODOS" -gt "${{ env.BASELINE_TODOS }}" ] || \
             [ "$HIGH" -gt "${{ env.BASELINE_VULNS }}" ] || \
             [ "$DEAD" -gt "${{ env.BASELINE_DEAD_EXPORTS }}" ]; then
            NEEDS_ISSUE=true
          fi

          echo "needs_issue=$NEEDS_ISSUE" >> $GITHUB_OUTPUT

      - name: Create refactoring issue
        if: steps.should-create-issue.outputs.needs_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            const largeFilesContent = fs.readFileSync('/tmp/large-files.txt', 'utf8').trim();
            const todosContent = fs.readFileSync('/tmp/todos.txt', 'utf8').trim();
            const auditSummary = fs.readFileSync('/tmp/npm-audit-summary.txt', 'utf8').trim();
            const deadExports = fs.readFileSync('/tmp/dead-exports.txt', 'utf8').trim();

            const largeCount = ${{ steps.large-files.outputs.large_count }};
            const todoCount = ${{ steps.todos.outputs.todo_count }};
            const highCount = ${{ steps.npm-audit.outputs.high_count }};
            const deadCount = ${{ steps.dead-exports.outputs.dead_count }};

            const baselineL = ${{ env.BASELINE_LARGE_FILES }};
            const baselineT = ${{ env.BASELINE_TODOS }};
            const baselineV = ${{ env.BASELINE_VULNS }};
            const baselineD = ${{ env.BASELINE_DEAD_EXPORTS }};

            const flag = (current, baseline) =>
              current > baseline ? '\u26A0\uFE0F NEW (' + current + ' vs baseline ' + baseline + ')' :
                                   '\u2705 Baseline (' + current + ')';

            // Build dynamic remediation prompt sections based on what exceeded baselines
            const p1 = highCount > baselineV
              ? 'PRIORITY 1 \u2014 New high-severity npm vulnerabilities (' + highCount + ' vs baseline ' + baselineV + '):\n\n' +
                (auditSummary || 'See npm audit output above') + '\n\n' +
                'Action: Run npm audit fix and report what was fixed. If npm audit fix does not resolve them, report which packages are affected and whether npm audit fix --force would introduce breaking changes.'
              : 'PRIORITY 1 \u2014 npm vulnerabilities: None new \u2014 at baseline (' + baselineV + ' high-severity). Skip this section.';

            const p2 = todoCount > baselineT
              ? 'PRIORITY 2 \u2014 New TODO/HACK/FIXME comments (' + todoCount + ' found, baseline is ' + baselineT + '):\n\n' +
                todosContent + '\n\n' +
                'Action: For each new TODO, either implement it (if small and safe) or add a comment documenting why it exists and when it should be addressed.'
              : 'PRIORITY 2 \u2014 TODO/HACK/FIXME comments: None new \u2014 at baseline (' + baselineT + '). Skip this section.';

            const p3 = largeCount > baselineL
              ? 'PRIORITY 3 \u2014 Files newly exceeding 500 lines (' + largeCount + ' found, baseline is ' + baselineL + '):\n\n' +
                largeFilesContent + '\n\n' +
                'Action: For each newly large file, read it and assess: can a section be extracted into a separate utility or component? Are there duplicated patterns that could be consolidated? Report your assessment but only refactor if the extraction is clean and safe.'
              : 'PRIORITY 3 \u2014 Large files: None new \u2014 at baseline (' + baselineL + ' files over 500 lines). Skip this section.';

            const p4 = deadCount > baselineD
              ? 'PRIORITY 4 \u2014 Dead exports increased (' + deadCount + ' found, baseline is ' + baselineD + '):\n\n' +
                (deadExports || 'See dead exports section above') + '\n\n' +
                'Action: Unused exports flagged by knip \u2014 verify before removing (check dynamic imports, barrel re-exports, external consumers). knip AST analysis is accurate; the baseline of ' + baselineD + ' reflects the known state as of 2026-02-18.'
              : 'PRIORITY 4 \u2014 Dead exports: At baseline (' + baselineD + '). Skip this section.';

            const remediationPrompt = [
              'You are performing the weekly refactoring audit remediation for the Savvy Dashboard.',
              'Date: ' + date,
              '',
              'Read this entire prompt before starting. Work through each section in priority order.',
              'Only make changes you are confident are safe. If unsure, report the finding but do NOT change code.',
              '',
              '\u26A0\uFE0F RULES:',
              '- Read each file BEFORE making any changes',
              '- Run npx tsc --noEmit after each change to verify no type errors introduced',
              '- Do NOT remove exports unless you verify zero consumers (dynamic imports, barrel re-exports, test files)',
              '- For npm vulnerabilities: prefer npm audit fix over npm audit fix --force',
              '- After all changes, run: npm run gen:all to regenerate inventories',
              '',
              p1,
              '',
              p2,
              '',
              p3,
              '',
              p4,
              '',
              'After completing all priorities, report:',
              '- What changes were made',
              '- What was flagged but intentionally left unchanged (and why)',
              '- Results of npx tsc --noEmit',
              '- Results of npm run gen:all',
            ].join('\n');

            const lines = [
              '## \uD83D\uDD27 Weekly Refactoring Audit \u2014 ' + date,
              '',
              '> Metrics that exceed baselines are flagged with \u26A0\uFE0F NEW.',
              '> Baselines reflect the known state as of February 2026.',
              '',
              '---',
              '',
              '## \uD83D\uDCCF Large Files (>500 lines)',
              '',
              flag(largeCount, baselineL),
              '',
              largeFilesContent ? ('```\n' + largeFilesContent + '\n```') : '_None found_',
              '',
              '---',
              '',
              '## \uD83D\uDCDD TODO/HACK/FIXME Comments',
              '',
              flag(todoCount, baselineT),
              '',
              todosContent ? ('```\n' + todosContent + '\n```') : '_None found_',
              '',
              '---',
              '',
              '## \uD83D\uDD12 Dependency Vulnerabilities (high severity)',
              '',
              flag(highCount, baselineV),
              '',
              '```',
              auditSummary || 'Audit unavailable',
              '```',
              '',
              '---',
              '',
              '## \u267B\uFE0F Unused Exports (knip)',
              '',
              '> Detected by knip AST analysis \u2014 significantly more accurate than grep.',
              '> Ignores scripts/ and test files. See knip.json for configuration.',
              '',
              flag(deadCount, baselineD),
              '',
              deadExports || '_None found_',
              '',
              '---',
              '',
              '## \uD83E\uDD16 Claude Code Prompt (copy-paste into Claude Code)',
              '',
              'The following prompt is ready to paste directly into Claude Code:',
              '',
              '---',
              '',
              '```',
              remediationPrompt,
              '```',
              '',
              '---',
              '_This issue was created automatically by the Weekly Refactoring Audit workflow._'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '\uD83D\uDD27 Weekly Refactoring Audit \u2014 ' + date,
              body: lines,
              labels: ['refactoring', 'automated-audit']
            });
