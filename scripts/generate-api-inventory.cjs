'use strict';
/**
 * generate-api-inventory.cjs
 * Scans all route.ts files under src/app/api/ and produces docs/_generated/api-routes.md
 * Run with: node scripts/generate-api-inventory.cjs
 */

const fs = require('fs');
const path = require('path');

const PROJECT_ROOT = path.join(__dirname, '..');
const API_DIR = path.join(PROJECT_ROOT, 'src', 'app', 'api');
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'docs', '_generated', 'api-routes.md');

const HTTP_METHODS = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'];

/** Recursively find all route.ts files under a directory */
function findRouteFiles(dir) {
  const results = [];
  let items;
  try {
    items = fs.readdirSync(dir, { withFileTypes: true });
  } catch (e) {
    return results;
  }
  for (const item of items) {
    const fullPath = path.join(dir, item.name);
    if (item.isDirectory()) {
      results.push(...findRouteFiles(fullPath));
    } else if (item.name === 'route.ts') {
      results.push(fullPath);
    }
  }
  return results;
}

/** Detect exported HTTP methods in the full file */
function detectMethods(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  return HTTP_METHODS.filter(method => {
    // Pattern 1: export async function GET(...) / export function GET(...)
    if (new RegExp(`export\\s+(async\\s+)?function\\s+${method}\\b`).test(content)) return true;
    // Pattern 2: export { handler as GET, handler as POST } or export { GET, POST }
    if (new RegExp(`export\\s*\\{[^}]*\\bas\\s+${method}\\b`).test(content)) return true;
    if (new RegExp(`export\\s*\\{[^}]*\\b${method}\\b`).test(content)) return true;
    return false;
  });
}

/** Convert absolute file path to API route string (e.g. /api/dashboard/funnel-metrics) */
function extractApiPath(filePath) {
  const relative = path.relative(API_DIR, filePath);
  // Remove trailing \route.ts or /route.ts, normalize separators
  const withoutFile = relative.replace(/[\\/]route\.ts$/, '').replace(/\\/g, '/');
  return '/api/' + withoutFile;
}

/** Get the top-level feature name (first segment after /api/) */
function getFeature(apiPath) {
  const parts = apiPath.split('/'); // ['', 'api', 'feature', ...]
  return parts[2] || 'root';
}

/** Build relative file path string for display */
function relativeFilePath(filePath) {
  return path.relative(PROJECT_ROOT, filePath).replace(/\\/g, '/');
}

// ── Main ────────────────────────────────────────────────────────────────────

const routeFiles = findRouteFiles(API_DIR);
routeFiles.sort();

const routes = routeFiles.map(filePath => {
  const apiPath = extractApiPath(filePath);
  const methods = detectMethods(filePath);
  const feature = getFeature(apiPath);
  const displayPath = relativeFilePath(filePath);
  return { apiPath, methods, feature, displayPath };
});

// Group by feature, preserving sort order
const features = {};
for (const route of routes) {
  if (!features[route.feature]) features[route.feature] = [];
  features[route.feature].push(route);
}

// Build markdown output
const now = new Date().toISOString().replace('T', ' ').slice(0, 19);
const totalFiles = routes.length;
const featureNames = Object.keys(features).sort();
const totalFeatures = featureNames.length;

let md = `# API Routes Inventory (Auto-Generated)\n\n`;
md += `> This file is auto-generated by \`npm run gen:api-routes\`. Do not edit manually.\n`;
md += `> Generated: ${now}\n`;
md += `> Total: ${totalFiles} route files across ${totalFeatures} feature areas\n\n`;

for (const feature of featureNames) {
  const featureRoutes = features[feature].slice().sort((a, b) =>
    a.apiPath.localeCompare(b.apiPath)
  );
  const displayName = feature.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  md += `## ${displayName}\n\n`;
  md += `| Route | Methods | File Path |\n`;
  md += `|-------|---------|----------|\n`;
  for (const route of featureRoutes) {
    const methods = route.methods.length > 0 ? route.methods.join(', ') : '(none detected)';
    md += `| \`${route.apiPath}\` | ${methods} | \`${route.displayPath}\` |\n`;
  }
  md += '\n';
}

fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
fs.writeFileSync(OUTPUT_FILE, md, 'utf8');
console.log(`✓ Generated api-routes.md: ${totalFiles} route files across ${totalFeatures} feature areas`);
