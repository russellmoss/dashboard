# Savvy Funnel Analytics Dashboard - Project Instructions

## Project Context

You are working on the **Savvy Funnel Analytics Dashboard**, a Next.js 14 application that replaces Tableau for funnel analytics. The dashboard connects to BigQuery and visualizes data from the `vw_funnel_master` view.

**Repository**: https://github.com/russellmoss/dashboard  
**Current Status**: All core phases complete (1-8), Full Funnel View implemented, SGA/SGM Active Filter implemented, Column sorting added

## Key Principles

1. **Data Source**: All queries must use the `vw_funnel_master` view (`savvy-gtm-analytics.Tableau_Views.vw_funnel_master`)
2. **Security**: Always use BigQuery parameterized queries (`@paramName` syntax) - never string interpolation
3. **Type Safety**: Use TypeScript types from `src/types/` - maintain type consistency
4. **Date Dimensions**: Each conversion rate has a specific date field:
   - Contacted→MQL: `stage_entered_contacting__c`
   - MQL→SQL: `converted_date_raw` (numerator), `stage_entered_contacting__c` (denominator)
   - SQL→SQO: `Date_Became_SQO__c` (numerator), `converted_date_raw` (denominator)
   - SQO→Joined: `advisor_join_date__c` (numerator), `Date_Became_SQO__c` (denominator)
5. **Deduplication**: Use `is_sqo_unique` and `is_joined_unique` for opportunity-level metrics
6. **Record Type**: SQO calculations must filter by `recordtypeid = '012Dn000000mrO3IAI'` (Recruiting)

## Architecture Patterns

### Query Functions (`src/lib/queries/`)
- Use `runQuery<T>()` from `src/lib/bigquery.ts`
- Always use parameterized queries with `@paramName` syntax
- Return typed results using interfaces from `src/types/bigquery-raw.ts`
- Transform raw results to dashboard types in the query function

### API Routes (`src/app/api/dashboard/`)
- Use `getServerSession()` for authentication
- Apply permission-based filters via `getUserPermissions()`
- Return `NextResponse.json()` with proper error handling
- Log errors but don't expose sensitive details

### Components (`src/components/dashboard/`)
- Use client components (`'use client'`) for interactivity
- Fetch data via `dashboardApi` from `src/lib/api-client.ts`
- Handle loading and error states
- Use Tremor components for tables/cards, Recharts for trend charts

### Date Filtering
- Use `buildDateRangeFromFilters()` from `src/lib/utils/date-helpers.ts`
- Apply date filters to the specific date field for each metric
- For trend charts, expand to full year: `YYYY-01-01` to `YYYY-12-31`

## Key Files Reference

### Core Query Logic
- `src/lib/queries/conversion-rates.ts` - Scorecard and trend chart queries
- `src/lib/queries/funnel-metrics.ts` - Volume metrics (SQLs, SQOs, Joined, AUM)
- `src/lib/queries/source-performance.ts` - Channel and source breakdowns

### Configuration
- `src/config/constants.ts` - Table names, record types, constants
- `src/types/dashboard.ts` - Dashboard data types
- `src/types/bigquery-raw.ts` - Raw BigQuery result types

### Components
- `src/components/dashboard/ConversionTrendChart.tsx` - Trend chart (uses Recharts)
- `src/components/dashboard/ConversionRateCards.tsx` - Scorecard cards
- `src/app/dashboard/page.tsx` - Main dashboard with data fetching

### Documentation
- `docs/GLOSSARY.md` - Business definitions and terminology
- `docs/CALCULATIONS.md` - Detailed calculation formulas (period vs cohort modes)
- `docs/FILTER-MATRIX.md` - Filter application by metric type
- `vw_funnel_master.sql` - BigQuery view definition with all flags

## Development Guidelines

### When Working with Conversion Rates

1. **Compare Logic**: Always compare `getConversionTrends()` with `getConversionRates()` to ensure consistency
2. **Test with Q4 2025**: Use Q4 2025 as test case (expected: 3.6% Contacted→MQL, 74.6% SQL→SQO, 11.6% SQO→Joined)
3. **Verify Volumes**: Ensure volumes match scorecard (144 SQOs, 17 Joined for Q4 2025)
4. **Period Alignment**: Group numerators and denominators by the same date field, or properly join them
5. **No Cohort Restrictions**: Don't restrict conversions to same-period only - count all valid conversions

### When Adding Features

1. **Follow Existing Patterns**: Match the structure of existing query functions and components
2. **Type Safety**: Define types in `src/types/` before implementing
3. **Error Handling**: Always handle errors gracefully with user-friendly messages
4. **Testing**: Test against known Q4 2025 values when possible

### When Debugging

1. **Check BigQuery View**: Verify logic against `vw_funnel_master.sql` structure
2. **Use Logger**: Use `logger.debug()` from `@/lib/logger` to track data flow (not console.log)
3. **Test Queries**: Test BigQuery queries directly before implementing in code
4. **Compare Scorecard**: If chart values differ, compare with scorecard calculation
5. **Check Documentation**: Refer to `docs/CALCULATIONS.md` and `docs/GLOSSARY.md` for definitions

## Important Constants

- **Recruiting Record Type**: `'012Dn000000mrO3IAI'`
- **Full Table**: `'savvy-gtm-analytics.Tableau_Views.vw_funnel_master'`
- **Mapping Table**: `'savvy-gtm-analytics.SavvyGTMData.new_mapping'`
- **Forecast Table**: `'savvy-gtm-analytics.SavvyGTMData.q4_2025_forecast'`

## Verification Values (Q4 2025)

Use these as test cases when debugging:
- SQLs: 193
- SQOs: 144
- Joined: 17
- Contacted→MQL: 3.6%
- MQL→SQL: 34.2%
- SQL→SQO: 74.6%
- SQO→Joined: 11.6%
- Open Pipeline AUM: ~$12.3B

## Code Style

- Use TypeScript strict mode
- Prefer async/await over promises
- Use descriptive variable names
- Add comments for complex logic
- Follow Next.js 14 App Router patterns
- Use Tailwind CSS for styling

## When Making Changes

1. **Read Related Files**: Understand the full context before changing
2. **Maintain Consistency**: Keep patterns consistent with existing code
3. **Update Types**: Update TypeScript types if data structures change
4. **Test Locally**: Run `npm run dev` and test changes
5. **Document Changes**: Update relevant documentation if needed

## Priority Focus Areas

1. **Maintain Data Accuracy**: Ensure all metrics match BigQuery view calculations
2. **Performance**: Optimize queries and add caching where appropriate
3. **User Experience**: Improve error messages and loading states
4. **Documentation**: Keep `docs/GLOSSARY.md`, `docs/CALCULATIONS.md`, and `docs/FILTER-MATRIX.md` updated

## Questions to Ask Before Making Changes

- Does this match the `vw_funnel_master` view logic?
- Are we using the correct date field for this metric?
- Are we properly deduplicating opportunity-level metrics?
- Are we filtering by the correct record type for SQO calculations?
- Does this maintain consistency with the scorecard calculations?

## Common Pitfalls - AVOID THESE

### ❌ Using Wrong Deduplication Field
- **WRONG**: `COUNT(*) WHERE is_sqo = 1`
- **RIGHT**: `COUNT(*) WHERE is_sqo_unique = 1`
- **WHY**: Multiple leads can convert to one opportunity. Use `is_sqo_unique` for volume counts, `is_sqo` for progression flags.

### ❌ Missing Record Type Filter for SQOs
- **WRONG**: `WHERE is_sqo_unique = 1`
- **RIGHT**: `WHERE is_sqo_unique = 1 AND recordtypeid = '012Dn000000mrO3IAI'`
- **WHY**: Re-engagement opportunities have different record type. SQO/Joined metrics only count Recruiting opportunities.

### ❌ Using Wrong Date Field for Trend Grouping
- **WRONG**: Grouping numerator and denominator by different dates without proper joining
- **RIGHT**: Both must use same date field OR be properly joined with period alignment
- **WHY**: Mismatched periods give nonsensical rates. Period mode requires entry AND resolution in same period.

### ❌ Cohort Restrictions on Conversions
- **WRONG**: Only counting conversions where both dates are in same period
- **RIGHT**: Count all conversions where the ACTION date is in period (cohort mode allows cross-period conversions)
- **WHY**: A Q3 SQL can become a Q4 SQO - that's a valid Q4 conversion in cohort mode.

### ❌ Confusing SQL__c Field
- **WRONG**: Assuming `SQL__c` field means SQL status
- **RIGHT**: `SQL__c = 'Yes'` actually means SQO status (legacy naming)
- **WHY**: This is a Salesforce legacy naming issue. Always check the value, not the field name.

### ❌ Using Wrong SGA Field
- **WRONG**: Using `SGA_Owner_Name__c` for opportunity metrics
- **RIGHT**: Use `SGA_Owner_Name__c` for lead metrics, `Opp_SGA_Name__c` for opportunity metrics
- **WHY**: SGA attribution changes from Lead to Opportunity after conversion.

### ❌ Filtering by FilterDate for Volume Metrics
- **WRONG**: `WHERE FilterDate IN date_range` for volume counts
- **RIGHT**: Use specific date fields (`mql_stage_entered_ts`, `converted_date_raw`, `Date_Became_SQO__c`, etc.)
- **WHY**: Each metric has its own date field. `FilterDate` is for general filtering, not metric-specific dates.

### ❌ Period Mode Without Resolution Check
- **WRONG**: Counting all records that entered stage in period
- **RIGHT**: Count only records that entered AND resolved (progressed or closed) in same period
- **WHY**: Period mode excludes in-flight records. Both entry and resolution must be in period.

### ❌ Cohort Mode Including Open Records
- **WRONG**: Including open records in cohort denominators
- **RIGHT**: Use `eligible_for_*_conversions` flags which only include resolved records
- **WHY**: Cohort mode measures efficiency of resolved records only. Open records skew results.

### ❌ Missing Opportunity-Level Resolution
- **WRONG**: Using `lead_closed_date` for SQL→SQO resolution
- **RIGHT**: Use `StageName = 'Closed Lost'` and `Stage_Entered_Closed__c` for opportunity closure
- **WHY**: Once converted, resolution is tracked at Opportunity level, not Lead level.

## Rules and Commands

### Code Generation Rules

1. **Always use parameterized queries**: Never use string interpolation in SQL queries. Always use `@paramName` syntax with BigQuery parameters.

2. **Type safety first**: Always define TypeScript interfaces in `src/types/` before implementing query functions. Use `Raw*Result` types for BigQuery results.

3. **Error handling**: All API routes must have try/catch blocks and return appropriate HTTP status codes. Log errors but don't expose sensitive details.

4. **Date filtering**: When filtering by date, always use `TIMESTAMP(@paramName)` for BigQuery compatibility. Include time component for end dates: `endDate + ' 23:59:59'`.

5. **Deduplication**: For opportunity-level metrics (SQO, Joined, AUM), always use `is_sqo_unique`, `is_joined_unique`, or `is_primary_opp_record` flags.

6. **Record type filtering**: When querying SQOs, always include `recordtypeid = @recruitingRecordType` filter with `RECRUITING_RECORD_TYPE` constant.

### Testing Commands

Before committing changes that affect calculations:
1. Run `npm run build` to ensure TypeScript compiles
2. Test with Q4 2025 filters and verify values match expected:
   - SQLs: 193
   - SQOs: 144
   - Joined: 17
   - Contacted→MQL: 3.6%
   - SQL→SQO: 74.6%
   - SQO→Joined: 11.6%

### Code Review Checklist

When reviewing or modifying code:
- [ ] Uses parameterized queries (no string interpolation)
- [ ] Has proper TypeScript types
- [ ] Handles errors gracefully
- [ ] Uses correct date fields for each metric
- [ ] Properly deduplicates opportunity-level metrics
- [ ] Filters by correct record type for SQO calculations
- [ ] Matches scorecard logic (if modifying conversion rates)

### Debugging Workflow

1. **Identify the issue**: Check console logs, network requests, and component state
2. **Compare with scorecard**: If chart values differ, compare with `getConversionRates()` logic
3. **Test query directly**: Run BigQuery query in console to verify results
4. **Check date fields**: Ensure using correct date dimension for each metric
5. **Verify deduplication**: Check that `is_*_unique` flags are used correctly
6. **Test with known values**: Use Q4 2025 as test case

### File Modification Rules

- **Query files**: Always maintain consistency between `getConversionRates()` and `getConversionTrends()`
- **Component files**: Keep data transformation minimal - do it in query functions
- **Type files**: Update types when data structures change
- **API routes**: Always apply permission filters via `getUserPermissions()`

### Common Patterns

**Query Pattern**:
```typescript
const { startDate, endDate } = buildDateRangeFromFilters(filters);
const params: Record<string, any> = { startDate, endDate: endDate + ' 23:59:59' };
// Add filters to params
const query = `SELECT ... WHERE ... AND TIMESTAMP(@startDate) ...`;
const results = await runQuery<RawType>(query, params);
```

**API Route Pattern**:
```typescript
const session = await getServerSession(authOptions);
if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
const permissions = await getUserPermissions(session.user?.email || '');
// Apply permission filters
const data = await getDataFunction(filters);
return NextResponse.json(data);
```

**Component Pattern**:
```typescript
'use client';
import { useState, useEffect } from 'react';
import { dashboardApi } from '@/lib/api-client';
// Fetch data, handle loading/error states, render UI
```

---

**Remember**: The scorecard calculations in `getConversionRates()` are correct. Use them as the reference implementation when fixing the trend chart.
