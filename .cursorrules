# Savvy Funnel Analytics Dashboard - Project Instructions

## Project Context

You are working on the **Savvy Funnel Analytics Dashboard**, a Next.js 14 application that replaces Tableau for funnel analytics. The dashboard connects to BigQuery and visualizes data from the `vw_funnel_master` view.

**Repository**: https://github.com/russellmoss/dashboard  
**Current Status**: All core phases complete (1-8), Full Funnel View implemented, SGA/SGM Active Filter implemented, Column sorting added

---

## ‚ö†Ô∏è VERIFICATION PROTOCOL - MANDATORY

### Before Making ANY Calculation Changes

1. **READ `docs/GROUND-TRUTH.md` FIRST** - Contains verified values with cohort maturity tiers
2. **Use TIER 1 cohorts (Q1/Q2 2025) for validation** - These are fully baked and immutable
3. **Never validate calculation logic with Q4 2025** - Cohort is immature, rates WILL change

### Cohort Maturity Quick Reference

| Cohort | Status | Use For |
|--------|--------|---------|
| Q1 2025 | üü¢ STABLE (288 days) | Strict validation - values MUST match |
| Q2 2025 | üü¢ STABLE (197 days) | Secondary validation |
| Q3 2025 | üü° MATURING (105 days) | Directional checks only |
| Q4 2025 | üî¥ CURRENT (13 days) | UI/filter testing only |

### Q1 2025 Ground Truth (PRIMARY - Use This)

| Metric | Expected | Tolerance |
|--------|----------|-----------|
| SQLs | **123** | ¬±0 |
| SQOs | **96** | ¬±0 |
| Joined | **12** | ¬±0 |
| Contacted‚ÜíMQL | **4.94%** (314/6,360) | ¬±0.1% |
| MQL‚ÜíSQL | **27.70%** (123/444) | ¬±0.1% |
| SQL‚ÜíSQO | **70.83%** (85/120) | ¬±0.1% |
| SQO‚ÜíJoined | **12.20%** (10/82) | ¬±0.1% |

### Q2 2025 Ground Truth (SECONDARY)

| Metric | Expected | Tolerance |
|--------|----------|-----------|
| SQLs | **155** | ¬±0 |
| SQOs | **110** | ¬±0 |
| Joined | **13** | ¬±0 |
| Contacted‚ÜíMQL | **4.63%** (315/6,809) | ¬±0.1% |
| MQL‚ÜíSQL | **37.93%** (154/406) | ¬±0.1% |
| SQL‚ÜíSQO | **68.63%** (105/153) | ¬±0.1% |
| SQO‚ÜíJoined | **13.79%** (12/87) | ¬±0.1% |

### Verification Workflow

```
1. Read docs/GROUND-TRUTH.md for expected values
2. Make your code changes
3. Test with Q1 2025 filters (Jan 1 - Mar 31, 2025)
4. Compare results to TIER 1 ground truth
5. If mismatch ‚Üí STOP and investigate (do NOT proceed)
6. If match ‚Üí Test with Q4 2025 for sanity check
7. Document any findings
```

### Files That REQUIRE Verification After Changes

If you modify ANY of these files, you MUST verify against Q1/Q2 2025 ground truth:
- `src/lib/queries/conversion-rates.ts`
- `src/lib/queries/funnel-metrics.ts`
- `src/lib/queries/source-performance.ts`
- `src/app/api/dashboard/conversion-rates/route.ts`
- `src/app/api/dashboard/funnel-metrics/route.ts`
- `vw_funnel_master.sql`

### MCP Salesforce Verification (When Needed)

Use MCP to query Salesforce directly for fresh validation:

**SQOs:**
```sql
SELECT COUNT(Id) FROM Opportunity WHERE RecordType.Name = 'Recruiting' AND SQL__c = 'Yes' AND Date_Became_SQO__c >= [START] AND Date_Became_SQO__c <= [END]
```

**Joined:**
```sql
SELECT COUNT(Id) FROM Opportunity WHERE RecordType.Name = 'Recruiting' AND StageName = 'Joined' AND Advisor_Join_Date__c >= [START] AND Advisor_Join_Date__c <= [END]
```

**SQLs:**
```sql
SELECT COUNT(Id) FROM Lead WHERE IsConverted = true AND ConvertedDate >= [START] AND ConvertedDate <= [END]
```

---

## Key Principles

1. **Data Source**: All queries must use the `vw_funnel_master` view (`savvy-gtm-analytics.Tableau_Views.vw_funnel_master`)
2. **Security**: Always use BigQuery parameterized queries (`@paramName` syntax) - never string interpolation
3. **Type Safety**: Use TypeScript types from `src/types/` - maintain type consistency
4. **Date Dimensions & Flags**: Each conversion rate uses specific cohort dates and pre-calculated flags:
   | Conversion | Cohort Date | Numerator Flag | Denominator Flag |
   |------------|-------------|----------------|------------------|
   | Contacted‚ÜíMQL | `stage_entered_contacting__c` | `contacted_to_mql_progression` | `eligible_for_contacted_conversions` |
   | MQL‚ÜíSQL | `mql_stage_entered_ts` | `mql_to_sql_progression` | `eligible_for_mql_conversions` |
   | SQL‚ÜíSQO | `converted_date_raw` | `sql_to_sqo_progression` | `eligible_for_sql_conversions` |
   | SQO‚ÜíJoined | `Date_Became_SQO__c` | `sqo_to_joined_progression` | `eligible_for_sqo_conversions` |
5. **Deduplication**: Use `is_sqo_unique` and `is_joined_unique` for opportunity-level metrics
6. **Record Type**: SQO calculations must filter by `recordtypeid = '012Dn000000mrO3IAI'` (Recruiting)

## Architecture Patterns

### Query Functions (`src/lib/queries/`)
- Use `runQuery<T>()` from `src/lib/bigquery.ts`
- Always use parameterized queries with `@paramName` syntax
- Return typed results using interfaces from `src/types/bigquery-raw.ts`
- Transform raw results to dashboard types in the query function

### API Routes (`src/app/api/dashboard/`)
- Use `getServerSession()` for authentication
- Apply permission-based filters via `getUserPermissions()`
- Return `NextResponse.json()` with proper error handling
- Log errors but don't expose sensitive details

### Components (`src/components/dashboard/`)
- Use client components (`'use client'`) for interactivity
- Fetch data via `dashboardApi` from `src/lib/api-client.ts`
- Handle loading and error states
- Use Tremor components for tables/cards, Recharts for trend charts

### Date Filtering
- Use `buildDateRangeFromFilters()` from `src/lib/utils/date-helpers.ts`
- Apply date filters to the specific date field for each metric
- For trend charts, expand to full year: `YYYY-01-01` to `YYYY-12-31`

## Key Files Reference

### Core Query Logic
- `src/lib/queries/conversion-rates.ts` - Scorecard and trend chart queries
- `src/lib/queries/funnel-metrics.ts` - Volume metrics (SQLs, SQOs, Joined, AUM)
- `src/lib/queries/source-performance.ts` - Channel and source breakdowns

### Configuration
- `src/config/constants.ts` - Table names, record types, constants
- `src/types/dashboard.ts` - Dashboard data types
- `src/types/bigquery-raw.ts` - Raw BigQuery result types

### Components
- `src/components/dashboard/ConversionTrendChart.tsx` - Trend chart (uses Recharts)
- `src/components/dashboard/ConversionRateCards.tsx` - Scorecard cards
- `src/app/dashboard/page.tsx` - Main dashboard with data fetching

### Documentation
- `docs/GROUND-TRUTH.md` - **Verified values with cohort maturity tiers (READ FIRST)**
- `docs/GLOSSARY.md` - Business definitions and terminology
- `docs/CALCULATIONS.md` - Detailed calculation formulas (period vs cohort modes)
- `docs/FILTER-MATRIX.md` - Filter application by metric type
- `conversion_rate_explanation.md` - Cohort mode explanation
- `vw_funnel_master.sql` - BigQuery view definition with all flags

## Development Guidelines

### When Working with Conversion Rates

1. **Read Ground Truth First**: Check `docs/GROUND-TRUTH.md` for expected values and cohort maturity
2. **Use TIER 1 for Validation**: Test with Q1 2025 (primary) or Q2 2025 (secondary)
3. **Use Pre-calculated Flags**: Always use `*_progression` for numerators, `eligible_for_*` for denominators
4. **Understand Cohort Mode**: Denominators only include RESOLVED records (converted OR closed)
5. **Never Restrict Cross-Period**: A Q4 SQL can become Q1 SQO - that's valid cohort behavior
6. **Verify After Changes**: Run BigQuery verification query against Q1/Q2 2025

### When Adding Features

1. **Follow Existing Patterns**: Match the structure of existing query functions and components
2. **Type Safety**: Define types in `src/types/` before implementing
3. **Error Handling**: Always handle errors gracefully with user-friendly messages
4. **Testing**: Test against known Q4 2025 values when possible

### When Debugging

1. **Check BigQuery View**: Verify logic against `vw_funnel_master.sql` structure
2. **Use Logger**: Use `logger.debug()` from `@/lib/logger` to track data flow (not console.log)
3. **Test Queries**: Test BigQuery queries directly before implementing in code
4. **Compare Scorecard**: If chart values differ, compare with scorecard calculation
5. **Check Documentation**: Refer to `docs/CALCULATIONS.md` and `docs/GLOSSARY.md` for definitions

## Important Constants

- **Recruiting Record Type**: `'012Dn000000mrO3IAI'`
- **Full Table**: `'savvy-gtm-analytics.Tableau_Views.vw_funnel_master'`
- **Mapping Table**: `'savvy-gtm-analytics.SavvyGTMData.new_mapping'`
- **Forecast Table**: `'savvy-gtm-analytics.SavvyGTMData.q4_2025_forecast'`

## Verification Values - TIERED APPROACH

### üü¢ TIER 1: Q1 2025 (STABLE - PRIMARY VALIDATION)

**Use for**: Strict validation of calculation logic  
**Status**: Fully baked (288 days) - Values are IMMUTABLE

| Metric | Expected |
|--------|----------|
| SQLs | 123 |
| SQOs | 96 |
| Joined | 12 |
| Contacted‚ÜíMQL | 4.94% (314/6,360) |
| MQL‚ÜíSQL | 27.70% (123/444) |
| SQL‚ÜíSQO | 70.83% (85/120) |
| SQO‚ÜíJoined | 12.20% (10/82) |

### üü¢ TIER 1: Q2 2025 (STABLE - SECONDARY VALIDATION)

**Use for**: Additional validation when needed  
**Status**: Fully baked (197 days) - Values are IMMUTABLE

| Metric | Expected |
|--------|----------|
| SQLs | 155 |
| SQOs | 110 |
| Joined | 13 |
| Contacted‚ÜíMQL | 4.63% (315/6,809) |
| MQL‚ÜíSQL | 37.93% (154/406) |
| SQL‚ÜíSQO | 68.63% (105/153) |
| SQO‚ÜíJoined | 13.79% (12/87) |

### üü° TIER 2: Q3 2025 (MATURING)

**Use for**: Directional validation  
**Status**: Mostly stable - SQO‚ÜíJoined may increase

| Metric | Expected |
|--------|----------|
| SQLs | 221 |
| SQOs | 133 |
| Joined | 15+ (may increase) |
| SQL‚ÜíSQO | ~67.8% |
| SQO‚ÜíJoined | ~17.5% (may increase to ~20%) |

### üî¥ TIER 3: Q4 2025 (CURRENT - SANITY CHECK ONLY)

**Use for**: UI testing, filter testing, sanity checks  
**Status**: IMMATURE - Rates WILL change significantly

| Metric | Value (as of Jan 13, 2026) | Notes |
|--------|---------------------------|-------|
| SQLs | 193 | Volume is stable |
| SQOs | 144 | Volume is stable |
| Joined | 17 | Will increase |
| SQO‚ÜíJoined | ~10% | Expect 15-20% when mature |

‚ö†Ô∏è **NEVER fail a build because Q4 2025 SQO‚ÜíJoined is "low"** - it hasn't baked yet!

## Code Style

- Use TypeScript strict mode
- Prefer async/await over promises
- Use descriptive variable names
- Add comments for complex logic
- Follow Next.js 14 App Router patterns
- Use Tailwind CSS for styling

## When Making Changes

1. **Read Related Files**: Understand the full context before changing
2. **Maintain Consistency**: Keep patterns consistent with existing code
3. **Update Types**: Update TypeScript types if data structures change
4. **Test Locally**: Run `npm run dev` and test changes
5. **Document Changes**: Update relevant documentation if needed

## Priority Focus Areas

1. **Maintain Data Accuracy**: Ensure all metrics match BigQuery view calculations
2. **Performance**: Optimize queries and add caching where appropriate
3. **User Experience**: Improve error messages and loading states
4. **Documentation**: Keep `docs/GLOSSARY.md`, `docs/CALCULATIONS.md`, and `docs/FILTER-MATRIX.md` updated

## Questions to Ask Before Making Changes

- Does this match the `vw_funnel_master` view logic?
- Are we using the correct date field for this metric?
- Are we properly deduplicating opportunity-level metrics?
- Are we filtering by the correct record type for SQO calculations?
- Does this maintain consistency with the scorecard calculations?

## Common Pitfalls - AVOID THESE

### ‚ùå Using Wrong Deduplication Field
- **WRONG**: `COUNT(*) WHERE is_sqo = 1`
- **RIGHT**: `COUNT(*) WHERE is_sqo_unique = 1`
- **WHY**: Multiple leads can convert to one opportunity. Use `is_sqo_unique` for volume counts, `is_sqo` for progression flags.

### ‚ùå Missing Record Type Filter for SQOs
- **WRONG**: `WHERE is_sqo_unique = 1`
- **RIGHT**: `WHERE is_sqo_unique = 1 AND recordtypeid = '012Dn000000mrO3IAI'`
- **WHY**: Re-engagement opportunities have different record type. SQO/Joined metrics only count Recruiting opportunities.

### ‚ùå Using Wrong Date Field for Trend Grouping
- **WRONG**: Grouping numerator and denominator by different dates without proper joining
- **RIGHT**: Both must use same date field OR be properly joined with period alignment
- **WHY**: Mismatched periods give nonsensical rates. Period mode requires entry AND resolution in same period.

### ‚ùå Cohort Restrictions on Conversions
- **WRONG**: Only counting conversions where both dates are in same period
- **RIGHT**: Count all conversions where the ACTION date is in period (cohort mode allows cross-period conversions)
- **WHY**: A Q3 SQL can become a Q4 SQO - that's a valid Q4 conversion in cohort mode.

### ‚ùå Confusing SQL__c Field
- **WRONG**: Assuming `SQL__c` field means SQL status
- **RIGHT**: `SQL__c = 'Yes'` actually means SQO status (legacy naming)
- **WHY**: This is a Salesforce legacy naming issue. Always check the value, not the field name.

### ‚ùå Using Wrong SGA Field
- **WRONG**: Using `SGA_Owner_Name__c` for opportunity metrics
- **RIGHT**: Use `SGA_Owner_Name__c` for lead metrics, `Opp_SGA_Name__c` for opportunity metrics
- **WHY**: SGA attribution changes from Lead to Opportunity after conversion.

### ‚ùå Filtering by FilterDate for Volume Metrics
- **WRONG**: `WHERE FilterDate IN date_range` for volume counts
- **RIGHT**: Use specific date fields (`mql_stage_entered_ts`, `converted_date_raw`, `Date_Became_SQO__c`, etc.)
- **WHY**: Each metric has its own date field. `FilterDate` is for general filtering, not metric-specific dates.

### ‚ùå Period Mode Without Resolution Check
- **WRONG**: Counting all records that entered stage in period
- **RIGHT**: Count only records that entered AND resolved (progressed or closed) in same period
- **WHY**: Period mode excludes in-flight records. Both entry and resolution must be in period.

### ‚ùå Cohort Mode Including Open Records
- **WRONG**: Including open records in cohort denominators
- **RIGHT**: Use `eligible_for_*_conversions` flags which only include resolved records
- **WHY**: Cohort mode measures efficiency of resolved records only. Open records skew results.

### ‚ùå Missing Opportunity-Level Resolution
- **WRONG**: Using `lead_closed_date` for SQL‚ÜíSQO resolution
- **RIGHT**: Use `StageName = 'Closed Lost'` and `Stage_Entered_Closed__c` for opportunity closure
- **WHY**: Once converted, resolution is tracked at Opportunity level, not Lead level.

### ‚ùå Validating with Immature Cohorts
- **WRONG**: Testing calculation changes with Q4 2025 and expecting stable rates
- **RIGHT**: Test with Q1/Q2 2025 (TIER 1) - these cohorts are fully baked
- **WHY**: SQO‚ÜíJoined takes 90-200 days to stabilize. Q4 2025 is only 13 days old.

### ‚ùå Not Using Pre-calculated Flags
- **WRONG**: `SUM(CASE WHEN is_mql = 1 AND is_sql = 1 THEN 1 END) / COUNT(*)` 
- **RIGHT**: `SUM(mql_to_sql_progression) / SUM(eligible_for_mql_conversions)`
- **WHY**: Flags handle edge cases (recycled leads, FilterDate checks, resolution status)

## Rules and Commands

### Code Generation Rules

1. **Always use parameterized queries**: Never use string interpolation in SQL queries. Always use `@paramName` syntax with BigQuery parameters.

2. **Type safety first**: Always define TypeScript interfaces in `src/types/` before implementing query functions. Use `Raw*Result` types for BigQuery results.

3. **Error handling**: All API routes must have try/catch blocks and return appropriate HTTP status codes. Log errors but don't expose sensitive details.

4. **Date filtering**: When filtering by date, always use `TIMESTAMP(@paramName)` for BigQuery compatibility. Include time component for end dates: `endDate + ' 23:59:59'`.

5. **Deduplication**: For opportunity-level metrics (SQO, Joined, AUM), always use `is_sqo_unique`, `is_joined_unique`, or `is_primary_opp_record` flags.

6. **Record type filtering**: When querying SQOs, always include `recordtypeid = @recruitingRecordType` filter with `RECRUITING_RECORD_TYPE` constant.

### Testing Commands

Before committing changes that affect calculations:

1. Run `npm run build` to ensure TypeScript compiles
2. **Test with Q1 2025 filters** (TIER 1 - Primary validation):
   - SQLs: 123
   - SQOs: 96
   - Joined: 12
   - Contacted‚ÜíMQL: 4.94% (314/6,360)
   - SQL‚ÜíSQO: 70.83% (85/120)
   - SQO‚ÜíJoined: 12.20% (10/82)
3. If Q1 2025 matches, test with Q4 2025 for sanity check
4. **Never fail validation based on Q4 2025 rates** - they're still baking

### Code Review Checklist

When reviewing or modifying code:
- [ ] Read `docs/GROUND-TRUTH.md` for expected values
- [ ] Uses parameterized queries (no string interpolation)
- [ ] Has proper TypeScript types
- [ ] Handles errors gracefully
- [ ] Uses correct cohort date fields for each metric
- [ ] Uses pre-calculated flags (`*_progression`, `eligible_for_*`)
- [ ] Properly deduplicates opportunity-level metrics
- [ ] Filters by correct record type for SQO calculations
- [ ] **Verified against Q1/Q2 2025 ground truth**

### Debugging Workflow

1. **Identify the issue**: Check console logs, network requests, and component state
2. **Compare with scorecard**: If chart values differ, compare with `getConversionRates()` logic
3. **Test query directly**: Run BigQuery query in console to verify results
4. **Check date fields**: Ensure using correct date dimension for each metric
5. **Verify deduplication**: Check that `is_*_unique` flags are used correctly
6. **Test with known values**: Use Q1 2025 as primary test case (TIER 1)

### File Modification Rules

- **Query files**: Always maintain consistency between `getConversionRates()` and `getConversionTrends()`
- **Component files**: Keep data transformation minimal - do it in query functions
- **Type files**: Update types when data structures change
- **API routes**: Always apply permission filters via `getUserPermissions()`

### Common Patterns

**Query Pattern**:
```typescript
const { startDate, endDate } = buildDateRangeFromFilters(filters);
const params: Record<string, any> = { startDate, endDate: endDate + ' 23:59:59' };
// Add filters to params
const query = `SELECT ... WHERE ... AND TIMESTAMP(@startDate) ...`;
const results = await runQuery<RawType>(query, params);
```

**API Route Pattern**:
```typescript
const session = await getServerSession(authOptions);
if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
const permissions = await getUserPermissions(session.user?.email || '');
// Apply permission filters
const data = await getDataFunction(filters);
return NextResponse.json(data);
```

**Component Pattern**:
```typescript
'use client';
import { useState, useEffect } from 'react';
import { dashboardApi } from '@/lib/api-client';
// Fetch data, handle loading/error states, render UI
```

---

**Critical Reminders**:
1. **Ground Truth**: `docs/GROUND-TRUTH.md` is the source of truth - Q1/Q2 2025 values are IMMUTABLE
2. **Cohort Maturity**: Recent cohorts (Q4 2025) have artificially low SQO‚ÜíJoined rates - this is expected
3. **Pre-calculated Flags**: Always use `*_progression` and `eligible_for_*` flags from `vw_funnel_master`
4. **Validation Order**: Q1 2025 first ‚Üí Q2 2025 second ‚Üí Q4 2025 for sanity only
5. **Never fail on Q4**: If Q4 2025 SQO‚ÜíJoined is low, that's expected - cohort isn't mature

**Remember**: The scorecard calculations in `getConversionRates()` are correct. Use them as the reference implementation when fixing the trend chart.
