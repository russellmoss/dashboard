generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  passwordHash   String?  // Optional for OAuth-only users
  role           String   @default("viewer")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  externalAgency String?  // Links recruiter to their External Agency (matches External_Agency__c in Salesforce)

  // Relations (keep existing relations as-is)
  savedReports        SavedReport[]
  gameScores          GameScore[]
  passwordResetTokens PasswordResetToken[]
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

model WeeklyGoal {
  id                     String   @id @default(cuid())
  userEmail              String // Links to User.email - matches SGA_Owner_Name__c via User.name
  weekStartDate          DateTime @db.Date // Monday of the week (DATE only)
  initialCallsGoal       Int      @default(0)
  qualificationCallsGoal Int      @default(0)
  sqoGoal                Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  createdBy              String? // Email of user who created
  updatedBy              String? // Email of user who last updated

  @@unique([userEmail, weekStartDate])
  @@index([userEmail])
  @@index([weekStartDate])
}

model QuarterlyGoal {
  id        String   @id @default(cuid())
  userEmail String // Links to User.email
  quarter   String // Format: "2026-Q1", "2026-Q2", etc.
  sqoGoal   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Email of admin who set it
  updatedBy String? // Email of admin who last updated

  @@unique([userEmail, quarter])
  @@index([userEmail])
  @@index([quarter])
}

model ManagerQuarterlyGoal {
  id        String   @id @default(cuid())
  quarter   String // Format: "2026-Q1", "2026-Q2", etc. (matches QuarterlyGoal format)
  sqoGoal   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Email of admin/manager who created
  updatedBy String? // Email of admin/manager who last updated

  @@unique([quarter])
  @@index([quarter])
  @@map("manager_quarterly_goals")
}

model ExploreFeedback {
  id         String   @id @default(cuid())
  userId     String? // User email (from session.user.email)
  question   String // The user's question
  questionId String // Unique ID for the question (timestamp or UUID)
  templateId String // Template that was selected
  feedback   String // 'positive' or 'negative'
  comment    String? // Required comment for negative feedback, optional for positive
  createdAt  DateTime @default(now())

  // Store the full query context for debugging
  compiledQuery Json? // Store the compiled SQL and params as JSON
  executableSql String? // Store the executable SQL (with parameters substituted) for BigQuery
  resultSummary Json? // Store row count, execution time, visualization type, etc. as JSON
  error         String? // Store error message if query failed (parsing error, execution error, etc.)

  @@index([userId])
  @@index([templateId])
  @@index([feedback])
  @@index([createdAt])
  @@index([error])
}

// Pipeline Catcher Game Leaderboard
model GameScore {
  id String @id @default(cuid())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Score data
  score          BigInt // Total AUM caught (stored in dollars)
  advisorsCaught Int // Number of SQOs caught
  joinedCaught   Int // Number of Joined advisors caught (bonus)
  ghostsHit      Int // Number of ghosts/stop signs hit

  // Game context
  quarter      String // e.g., "2025-Q1", "2025-Q2"
  gameDuration Int // Seconds played (max 180)

  // Leaderboard message
  message String? @db.VarChar(100)

  // Timestamps
  playedAt DateTime @default(now())

  // Indexes for fast leaderboard queries
  @@index([quarter, score(sort: Desc)])
  @@index([userId])
  @@index([playedAt])
}

model SavedReport {
  id               String   @id @default(cuid())
  userId           String? // NULL for admin templates
  name             String   @db.VarChar(255)
  description      String?  @db.VarChar(500)
  filters          Json // Complete DashboardFilters object
  featureSelection Json? // Optional FeatureSelection object (null = show all)
  viewMode         String?  @default("focused") // 'focused' | 'fullFunnel'
  dashboard        String   @default("funnel_performance")
  reportType       String   @default("user") // 'user' | 'admin_template'
  isDefault        Boolean  @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String? // Email of creator

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Note: Unique constraint for one default per user must be enforced in application logic
  // Prisma doesn't support WHERE clauses in @@unique constraints

  @@index([userId])
  @@index([reportType])
  @@index([isDefault])
  @@index([isActive])
  @@index([dashboard])
}
